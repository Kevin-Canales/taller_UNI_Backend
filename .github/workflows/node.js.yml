# Nombre del workflow que aparecer치 en la pesta침a Actions de GitHub
name: CI/CD Pipeline
# Define cu치ndo se ejecutar치 este workflow
on:
  # Se ejecuta cuando hay un push a las ramas especificadas
  push:
    branches:
      - main # Rama principal
      - develop # Rama de desarrollo (opcional, puedes eliminarla si no la usas)
  # Se ejecuta cuando se crea un Pull Request hacia estas ramas
  pull_request:
    branches:
      - main
      - develop
# Define las variables de entorno globales para todos los jobs
env:
  NODE_VERSION: '20.x' # Versi칩n de Node.js a utilizar
# Define los trabajos (jobs) que se ejecutar치n
jobs:
  # ============================================
  # JOB 1: LINTING Y VERIFICACI칍N DE C칍DIGO
  # ============================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest # Sistema operativo donde se ejecutar치
steps:
  # Descarga el c칩digo del repositorio
  - name: Checkout code
    uses: actions/checkout@v4
  # Configura Node.js en el runner
  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: ${{ env.NODE_VERSION }}
      cache: 'npm' # Cachea las dependencias de npm para acelerar builds
  # Instala las dependencias del proyecto
  - name: Install dependencies
    run: npm ci # ci es m치s r치pido y confiable que install para CI
  # Ejecuta ESLint para verificar la calidad del c칩digo
  - name: Run ESLint
    run: npm run lint
# ============================================
# JOB 2: BUILD DEL PROYECTO
# ============================================
build:
  name: 游멆잺Build Application
  runs-on: ubuntu-latest
  needs: lint # Este job espera a que 'lint' termine exitosamente
  steps:
  - name: Checkout code
  uses: actions/checkout@v4

- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: ${{ env.NODE_VERSION }}
    cache: 'npm'

- name: Install dependencies
  run: npm ci

# Genera el cliente de Prisma (necesario para el build)
- name: Generate Prisma Client
  run: npx prisma generate

# Compila la aplicaci칩n NestJS
- name: Build project
  run: npm run build

# Guarda los artefactos del build para usarlos en otros jobs
- name: Upload build artifacts
  uses: actions/upload-artifact@v4
  with:
    name: dist
    path: dist/
    retention-days: 1 # Mantiene los artefactos por 1 d칤a

# ============================================
# JOB 3: TESTS UNITARIOS
# ============================================
test:
  name: Run Tests
  runs-on: ubuntu-latest
  needs: build # Espera a que el build termine
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate Prisma Client
      run: npx prisma generate

    # Ejecuta los tests unitarios con Jest
    - name: Run unit tests
      run: npm run test -- --passWithNoTests
      # --passWithNoTests permite que pase aunque no haya tests (칰til al iniciar)

    # Ejecuta los tests con cobertura de c칩digo
    - name: Run tests with coverage
      run: npm run test:cov -- --passWithNoTests

    # Sube el reporte de cobertura como artefacto
    - name: Upload coverage report
  uses: actions/upload-artifact@v4
  with:
    name: coverage-report
    path: coverage/
    retention-days: 7

# ============================================
# JOB 4: NOTIFICACI칍N DE ESTADO (OPCIONAL)
# ============================================

notify:
  name: Notify Status
  runs-on: ubuntu-latest
  needs: [test]
  if: always() # Se ejecuta siempre, incluso si hay fallos

  steps:
    - name: Check workflow status
      run: |
        echo "Pipeline execution completed!"
        echo "Deploy status: ${{ needs.deploy.result }}"
